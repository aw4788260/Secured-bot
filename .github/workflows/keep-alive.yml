name: Supabase Keep-Alive

on:
  schedule:
    # Ø§Ù„Ø£ÙØ¶Ù„ ØªØ´ØºÙŠÙ„Ù‡ ÙƒÙ„ 6 Ø³Ø§Ø¹Ø§Øª Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø§Ø­ØªØ³Ø§Ø¨ ÙØªØ±Ø© Ø®Ù…ÙˆÙ„ Ø·ÙˆÙŠÙ„Ø©
    - cron: "0 */6 * * *"
  workflow_dispatch: {}

jobs:
  wake-up-and-verify:
    runs-on: ubuntu-latest
    steps:
      - name: Ping Supabase and Verify Status
        env:
          # Ø±Ø§Ø¨Ø· Ù…Ø´Ø±ÙˆØ¹Ùƒ ÙƒÙ…Ø§ Ø£Ø±Ø³Ù„ØªÙ‡
          SUPABASE_URL: 'https://guoobhdvfiqlvdomrbvo.supabase.co/rest/v1/users?select=id&limit=1'
          SUPABASE_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          MAX_RETRIES=5
          RETRY_DELAY=15
          
          echo "ğŸ“¡ Connecting to Supabase..."
          
          for ((i=1; i<=MAX_RETRIES; i++)); do
            # Ù†Ø±Ø³Ù„ Ø§Ù„Ø·Ù„Ø¨ ÙˆÙ†Ø®Ø²Ù† ÙƒÙˆØ¯ Ø§Ù„Ø­Ø§Ù„Ø© ÙÙ‚Ø· (Ù…Ø«Ù„ 200 Ø£Ùˆ 500)
            HTTP_STATUS=$(curl -o /dev/null -s -w "%{http_code}" -X GET "$SUPABASE_URL" \
              -H "apikey: $SUPABASE_KEY" \
              -H "Authorization: Bearer $SUPABASE_KEY")
            
            if [ "$HTTP_STATUS" -eq 200 ]; then
              echo "âœ… Success! Database is Active and Responding (Status: 200)."
              exit 0
            else
              echo "âš ï¸ Attempt $i/$MAX_RETRIES failed (Status: $HTTP_STATUS). Database might be sleeping..."
              
              if [ $i -lt $MAX_RETRIES ]; then
                echo "â³ Waiting ${RETRY_DELAY} seconds for wake-up..."
                sleep $RETRY_DELAY
              fi
            fi
          done
          
          echo "âŒ Critical: Failed to wake up database after $MAX_RETRIES attempts."
          exit 1
