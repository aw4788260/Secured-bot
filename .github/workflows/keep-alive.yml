name: Supabase Keep-Alive

on:
  schedule:
    # Ø§Ù„Ø£ÙØ¶Ù„ ØªØ´ØºÙŠÙ„Ù‡ ÙƒÙ„ 6 Ø³Ø§Ø¹Ø§Øª Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø§Ø­ØªØ³Ø§Ø¨ ÙØªØ±Ø© Ø®Ù…ÙˆÙ„ Ø·ÙˆÙŠÙ„Ø©
    - cron: "0 */6 * * *"
  workflow_dispatch: {}

jobs:
  wake-up-and-verify:
    runs-on: ubuntu-latest
    steps:
      - name: Ping Supabase and Verify Status
        env:
          # ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… select=* Ù„ØªØ¬Ù†Ø¨ Ø®Ø·Ø£ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¹Ù…ÙˆØ¯ id
          SUPABASE_URL: 'https://guoobhdvfiqlvdomrbvo.supabase.co/rest/v1/app_settings?select=*&limit=1'
          SUPABASE_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          MAX_RETRIES=5
          RETRY_DELAY=15
          
          echo "ğŸ“¡ Connecting to Supabase..."
          
          for ((i=1; i<=MAX_RETRIES; i++)); do
            # Ù†Ø±Ø³Ù„ Ø§Ù„Ø·Ù„Ø¨ ÙˆÙ†Ø®Ø²Ù† ÙƒÙˆØ¯ Ø§Ù„Ø­Ø§Ù„Ø© ÙÙ‚Ø·
            HTTP_STATUS=$(curl -o /dev/null -s -w "%{http_code}" -X GET "$SUPABASE_URL" \
              -H "apikey: $SUPABASE_KEY" \
              -H "Authorization: Bearer $SUPABASE_KEY")
            
            if [ "$HTTP_STATUS" -eq 200 ]; then
              echo "âœ… Success! Database is Active and Responding (Status: 200)."
              exit 0
            else
              echo "âš ï¸ Attempt $i/$MAX_RETRIES failed (Status: $HTTP_STATUS). Database might be sleeping..."
              
              # Ø·Ø¨Ø§Ø¹Ø© Ø±Ø¯ Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ø§Ù„ØªØ´Ø®ÙŠØµ Ø¥Ø°Ø§ ÙØ´Ù„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
              if [ "$HTTP_STATUS" -eq 400 ]; then
                 echo "âŒ Error 400: Check if Table or Column exists."
              fi

              if [ $i -lt $MAX_RETRIES ]; then
                echo "â³ Waiting ${RETRY_DELAY} seconds for wake-up..."
                sleep $RETRY_DELAY
              fi
            fi
          done
          
          echo "âŒ Critical: Failed to wake up database after $MAX_RETRIES attempts."
          exit 1
